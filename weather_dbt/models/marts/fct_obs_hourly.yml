version: 2

models:
  - name: fct_obs_hourly
    description: "{{ doc('fct_obs_hourly_doc') }}"
    tags: ["mart", "fact", "critical"]
    config:
      contract:
        enforced: true
    meta:
      owner: "Coralie Martinez"
      domain: "weather_analytics"
      criticality: "high"
      pii: false
      refresh_expectation: "hourly"
      usage: "Base analytique pour visualisation météo horaire et contrôles qualité"
      grain: "1 ligne = 1 station_id x 1 validity_time_utc"
    columns:

      # --- clés & grain ---
      - name: event_id
        description: Clé unique (station_id + validity_time_utc).
        data_type: varchar
        tests:
          - not_null
          - unique

      - name: station_id
        description: Identifiant station utilisé pour joindre la dimension.
        data_type: varchar
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_stations')
                field: station_id

      - name: station_name
        description: Nom de la station issu de la dimension stations.
        data_type: varchar

      - name: validity_time_utc
        description: Heure de validité de l'observation (UTC).
        data_type: timestamptz
        tests:
          - not_null

      # --- Fenêtres (cumul précipitations) ---
      - name: precip_1h_mm
        description: Précipitations cumulées sur les 1h précédentes (mm).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn

      - name: precip_3h_mm
        description: Précipitations cumulées sur les 3h précédentes (mm).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn

      - name: precip_24h_mm
        description: Précipitations cumulées sur les 24h précédentes (mm).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn
      - name: precip_intensity_level
        description: Niveau ordinal d’intensité des précipitations 24h (jointure dim_precip_intensity).
        data_type: integer
      - name: precip_intensity_label
        description: Libellé descriptif d’intensité des précipitations 24h (faible, modérée, forte, etc.).
        data_type: varchar


      # --- Fenêtres (neige) ---
      - name: snow_1h_m
        description: Neige cumulée sur 1h (m).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn


      - name: snow_3h_m
        description: Neige cumulée sur 3h (m).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn


      - name: snow_24h_m
        description: Neige cumulée sur 24h (m).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn
      - name: snow_intensity_level
        description: Niveau ordinal d’intensité neige 24h (jointure dim_snow_intensity).
        data_type: integer
      - name: snow_intensity_label
        description: Libellé descriptif de l’intensité neige 24h.
        data_type: varchar


      # --- Fenêtres (température) ---
      - name: temp_1h_c
        description: Moyenne glissante de température sur 1h (°C).
        data_type: double
        tests:
          - between_range:
              arguments:
                min_value: -40
                max_value: 60
              config:
                severity: warn


      - name: temp_3h_c
        description: Moyenne glissante de température sur 3h (°C).
        data_type: double
        tests:
          - between_range:
              arguments:
                min_value: -40
                max_value: 60
              config:
                severity: warn

      - name: temp_24h_c
        description: Moyenne glissante de température sur 24h (°C).
        data_type: double
        tests:
          - between_range:
              arguments:
                min_value: -40
                max_value: 60
              config:
                severity: warn

      # --- Features atomiques ---
      - name: wind_dir_deg
        description: Direction du vent (°).
        data_type: integer
        tests:
          - between_range:
              arguments:
                min_value: 0
                max_value: 360

      - name: wind_sector
        description: Secteur cardinal du vent (N, NE, E, SE, S, SW, W, NW).
        data_type: varchar
        tests:
          - accepted_values:
              arguments:
                values: ["N", "NE", "E", "SE", "S", "SW", "W", "NW"]

      - name: wind_speed_ms
        description: Vitesse du vent en m/s (unité de la source brute).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn

      - name: wind_speed_kmh
        description: Vitesse du vent en km/h (convertie depuis m/s).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn

      # --- Enrichissement Beaufort ---
      - name: wind_beaufort
        description: Niveau de l’échelle de Beaufort (0–12) dérivé de la vitesse du vent (jointure dim_beaufort).
        data_type: integer
        tests:
          - relationships:
              arguments:
                to: ref('dim_beaufort')
                field: beaufort_level
          - between_range:
              arguments:
                min_value: 0
                max_value: 12

      - name: wind_beaufort_label
        description: Libellé descriptif du niveau Beaufort (ex. calme, brise légère, coup de vent).
        data_type: varchar

      # --- Visibilité & flags ---
      - name: visibility_m
        description: Visibilité horizontale (m).
        data_type: integer
        tests:
          - non_negative:
              config:
                severity: warn

      - name: visibility_cat
        description: Catégorie de visibilité dérivée de visibility_m.
        data_type: varchar

      - name: freezing_flag
        description: >
          Indicateur de gel : 1 si température ≤ 0°C, 0 si > 0°C,
          NULL si la température n’est pas disponible.
        data_type: integer
        tests:
          - accepted_values:
              arguments:
                values: [0, 1]
          - freezing_flag_matches_value:
              arguments:
                value_column: temperature_c

      - name: precip_flag
        description: >
          Indicateur de pluie : 1 si précipitation horaire > 0 mm, 0 sinon. 
          NULL si la précipitation n’est pas disponible.
        data_type: integer
        tests:
          - accepted_values:
              arguments:
                values: [0, 1]
          - precip_flag_matches_value:
              arguments:
                value_column: precip_mm_h

      - name: snow_on_ground_flag
        description: >
          Indicateur de neige : 1 si hauteur de neige au sol > 0 sinon.
          NULL si la hauteur de neige au sol n’est pas disponible.
        data_type: integer
        tests:
          - accepted_values:
              arguments:
                values: [0, 1]
          - snow_flag_matches_value:
              arguments:
                value_column: snow_depth_m

      # --- Mesures brutes utiles ---
      - name: precip_mm_h
        description: Précipitation horaire (mm).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn

      - name: snow_depth_m
        description: Hauteur de neige (m).
        data_type: double
        tests:
          - non_negative:
              config:
                severity: warn

      - name: temperature_c
        description: Température horaire (°C).
        data_type: double
        tests:
          - between_range:
              arguments:
                min_value: -50
                max_value: 60
              config:
                severity: warn

      - name: humidity_pct
        description: Humidité relative (%).
        data_type: integer
        tests:
          - between_range:
              arguments:
                min_value: 0
                max_value: 100
